@model Reservation
@using CarReservationSystemApp

@{
    ViewData["Title"] = "Nowa rezerwacja";
}

<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">Nowa rezerwacja</h2>
            <a asp-action="Index" class="btn btn-outline-secondary">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-left" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8"/>
                </svg>
                Powrót
            </a>
        </div>

        <div class="card shadow-sm">
            <div class="card-body p-4">
                <form asp-action="Create" method="post">
                    <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

                    <!-- SAMOCHÓD -->
                    <div class="mb-4">
                        <label asp-for="CarId" class="form-label fw-bold">Wybierz samochód</label>
                        <select asp-for="CarId"
                                asp-items="ViewBag.Cars"
                                class="form-select form-select-lg"
                                id="carSelect"
                                required>
                            <option value="">-- Wybierz samochód --</option>
                        </select>
                        <span asp-validation-for="CarId" class="text-danger"></span>
                    </div>

                    <!-- DATY -->
                    <div class="row mb-4">
                        <div class="col-md-6 mb-3">
                            <label asp-for="From" class="form-label fw-bold">Data rozpoczęcia</label>
                            <input asp-for="From"
                                   type="date"
                                   class="form-control form-control-lg"
                                   id="fromDate"
                                   min="@DateTime.Today.ToString("yyyy-MM-dd")"
                                   required />
                            <span asp-validation-for="From" class="text-danger"></span>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label asp-for="To" class="form-label fw-bold">Data zakończenia</label>
                            <input asp-for="To"
                                   type="date"
                                   class="form-control form-control-lg"
                                   id="toDate"
                                   min="@DateTime.Today.AddDays(1).ToString("yyyy-MM-dd")"
                                   required />
                            <span asp-validation-for="To" class="text-danger"></span>
                        </div>
                    </div>

                    <!-- INFORMACJE O REZERWACJI -->
                    <div class="card bg-light mb-4">
                        <div class="card-body">
                            <h5 class="card-title">Szczegóły rezerwacji</h5>
                            <div class="row">
                                <div class="col-md-6 mb-2">
                                    <strong>Liczba dni:</strong>
                                    <span id="daysCount" class="text-primary">-</span>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <strong>Szacunkowy koszt:</strong>
                                    <span id="price" class="text-success fw-bold fs-5">-</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a asp-action="Index" class="btn btn-secondary btn-lg">
                            Anuluj
                        </a>
                        <button type="submit" class="btn btn-primary btn-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-check-circle" viewBox="0 0 16 16">
                                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                                <path d="m10.97 4.97-.02.022a.75.75 0 1 0 1.043 1.043l1.02-1.021a.75.75 0 0 0-1.042-1.042l-.998.999M11.99 8.99l-3.5-3.503a.75.75 0 0 0-1.05.024l-2 2a.75.75 0 0 0 .024 1.05l3.5 3.503a.75.75 0 0 0 1.05-.024l2-2a.75.75 0 0 0-.024-1.05"/>
                            </svg>
                            Zarezerwuj
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const fromDate = document.getElementById("fromDate");
        const toDate = document.getElementById("toDate");
        const priceField = document.getElementById("price");
        const daysCountField = document.getElementById("daysCount");
        const carSelect = document.getElementById("carSelect");

        // Ceny samochodów (będą pobierane z serwera)
        const carPrices = @Html.Raw(Json.Serialize(ViewBag.CarPrices ?? new Dictionary<int, decimal>()));

        // Pobierz cenę dla wybranego samochodu
        function getCarPrice(carId) {
            // Jeśli mamy cenę w ViewBag, użyj jej
            @if (ViewBag.SelectedCarPrice != null)
            {
                <text>
                if (carId == @Model.CarId) {
                    return @ViewBag.SelectedCarPrice;
                }
                </text>
            }
            
            // Domyślna cena (będzie obliczana po stronie serwera)
            return 150;
        }

        function calculatePrice() {
            if (fromDate.value && toDate.value && carSelect.value) {
                const from = new Date(fromDate.value);
                const to = new Date(toDate.value);

                if (to <= from) {
                    priceField.textContent = "Nieprawidłowy zakres dat";
                    daysCountField.textContent = "-";
                    return;
                }

                const diffTime = to - from;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays > 0) {
                    const pricePerDay = getCarPrice(parseInt(carSelect.value));
                    const totalPrice = diffDays * pricePerDay;
                    
                    daysCountField.textContent = diffDays + " " + (diffDays === 1 ? "dzień" : "dni");
                    priceField.textContent = totalPrice.toFixed(2) + " zł";
                } else {
                    priceField.textContent = "-";
                    daysCountField.textContent = "-";
                }
            } else {
                priceField.textContent = "-";
                daysCountField.textContent = "-";
            }
        }

        // Ustaw minimalną datę końcową na dzień po dacie początkowej
        fromDate.addEventListener("change", function() {
            if (fromDate.value) {
                const from = new Date(fromDate.value);
                from.setDate(from.getDate() + 1);
                toDate.min = from.toISOString().split('T')[0];
                
                if (toDate.value && toDate.value <= fromDate.value) {
                    toDate.value = "";
                }
            }
            calculatePrice();
        });

        toDate.addEventListener("change", calculatePrice);
        carSelect.addEventListener("change", calculatePrice);

        // Oblicz cenę przy załadowaniu strony
        if (fromDate.value && toDate.value && carSelect.value) {
            calculatePrice();
        }
    </script>
}
